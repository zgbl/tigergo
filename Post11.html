<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post10.html</title>
    <link rel="stylesheet" href="css/GoBoard4C.css" />
    <link rel="stylesheet" href="css/Styles5.css" />
    <!--<link rel="stylesheet" href="css/all.min.css" /> Copy è¿‡æ¥ä¸work-->
    <!--<link rel="stylesheet" href="fontawesome/css/all.min.css" /> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!--<link rel="stylesheet" href="css/MoreStyles1.css" /> -->
    <link rel="icon" href="https://zgbl.github.io/tigergo/favicon.ico" type="image/x-icon">

    <style>
      /* ç”¨æˆ·ä¿¡æ¯å®¹å™¨æ ·å¼  */
      #post-user-info {
        display: block;
        align-items: center;
        background-color: #f0f0f0;
        padding: 5px 10px;
        border-radius: 20px;
        font-family: Arial, sans-serif;
        margin: 10px 0;
        margin-left: 50px;
        width: 240px;
      }

      /*#user-info {
        position: absolute;
        top: 10px;
        right: 20px; /* æˆ– left: 20px; å–å†³äºæ‚¨æƒ³æ”¾åœ¨å“ªè¾¹ 
      } */

      /* ç”¨æˆ·å¤´åƒæ ·å¼ */
      #post-user-info .user-avatar {
        font-size: 24px;
        margin-right: 10px;
      }

      /* ç”¨æˆ·åæ ·å¼ */
      #post-user-info .user-name {
        font-weight: bold;
        margin-right: 10px;
      }

      #controls2 {
        display: block;
        margin-left: 50px;
      }
    </style>
  </head>
  <body>  
    <div id="navbar-placeholder"></div>

    <!--<div id="user-info" class="user-info-container"> -->

    <div id="post-user-info">
      User Info
      <span class="user-avatar">ğŸ‘¤</span>
      <span class="user-name"></span>
    </div>
    <!--<p>From /opt/homebrew/var/www/Post7B.html</p> -->
    <!-- <div id="board"></div> -->

    <div id="game-container">
      <div id="board">
        <!-- ç°æœ‰çš„æ£‹ç›˜å†…å®¹ -->
      </div>
      <div id="game-info">
        <h4>æ£‹å±€ä¿¡æ¯:</h3>
        <p><strong>é»‘æ£‹:</strong> <span id="black-player"></span> (<span id="black-rank"></span>)</p>
        <p><strong>ç™½æ£‹:</strong> <span id="white-player"></span> (<span id="white-rank"></span>)</p>
        <p><strong>æ—¥æœŸ:</strong> <span id="game-date"></span></p>
        <p><strong>ç»“æœ:</strong> <span id="game-result"></span></p>
        <p><strong>è´´ç›®:</strong> <span id="game-komi"></span></p>
        <p><strong>æ£‹ç›˜å¤§å°:</strong> <span id="board-size"></span></p>
        <p><strong>ç”¨æ—¶:</strong> <span id="time-control"></span></p>
        <p><strong>è§„åˆ™:</strong> <span id="game-rules"></span></p>
      </div>
    </div>

    <div id="controls2">
      <button id="logostartBtn" title="å›åˆ°å¼€å§‹" class="control-btn">
        <i class="fas fa-fast-backward"></i>
      </button>
      <button id="logofastBackwardBtn" title="å¿«é€€" class="control-btn">
        <i class="fas fa-step-backward"></i>
      </button>
      <button id="logobackwardBtn" title="åé€€" class="control-btn">
        <!-- <i class="fas fa-chevron-left"></i> -->
        <i class="fa-solid fa-square-caret-left"></i>
      </button>
      <button id="logoforwardBtn" title='å‰è¿›' class="control-btn">
        <!--<i class="fas fa-chevron-right"></i> -->
        <i class="fa-solid fa-square-caret-right"></i>
      </button>
      <button id="logofastForwardBtn" title="å¿«è¿›" class="control-btn">
        <i class="fas fa-step-forward"></i>
      </button>
      <button id="logoendBtn" title="å‰è¿›åˆ°åº•" class="control-btn">
        <i class="fas fa-fast-forward"></i>
      </button>
      <button id="logostudyBtn" title="ç ”ç©¶" class="control-btn">
        <i class="fas fa-book"></i>
      </button>
      <span class="status-indicator" id="studyIndicator"></span>
      <button
        id="logopublishVariationBtn"
        class="control-btn" title="å‘å¸ƒå˜åŒ–å›¾"
        style="display: none"
      >
        <i class="fas fa-share"></i>
      </button>
      <button id="logoshowMovesBtn" title="æ˜¾ç¤ºæ­¥æ•°" class="control-btn">
        <i class="fas fa-list-ol"></i>
      </button>
      <button id="logosaveQipuBtn" title="ä¿å­˜æ£‹è°±-å°šæœªå¼€å‘" class="control-btn">
        <i class="fas fa-save"></i>
      </button>
    </div>
    <div id="controls">
      <button id="startBtn" style="font-size: calc(var(--font-size) * 1.2)">
        å¼€å§‹
      </button>
      <button
        id="fastBackwardBtn"
        style="font-size: calc(var(--font-size) * 1.2)"
      >
        å¿«é€Ÿåé€€
      </button>
      <button id="backwardBtn" style="font-size: calc(var(--font-size) * 1.2)">
        åé€€
      </button>
      <button id="forwardBtn" style="font-size: calc(var(--font-size) * 1.2)">
        å‰è¿›
      </button>
      <button
        id="fastForwardBtn"
        style="font-size: calc(var(--font-size) * 1.2)"
      >
        å¿«é€Ÿå‰è¿›
      </button>
      <button id="endBtn" style="font-size: calc(var(--font-size) * 1.2)">
        ç»“æŸ
      </button>
      <button id="studyButton" style="font-size: calc(var(--font-size) * 1.2)">
        ç ”ç©¶
      </button>
      <button id="publishVariationBtn" style="display: none">å‘å¸ƒå˜åŒ–å›¾</button>
      <button id="showMovesBtn" style="font-size: calc(var(--font-size) * 1.2)">
        æ˜¾ç¤ºæ­¥æ•°
      </button>
      <button id="saveQipuBtn" style="font-size: calc(var(--font-size) * 1.2)">
        ä¿å­˜æ£‹è°±
      </button>
    </div>

    <div id="moveInfo">å½“å‰æ­¥æ•°ï¼š0 / 0</div>

    <div id="post-content">
      <h3 id="post-title"></h3>
      <p id="post-body"></p>
    </div>

    <div id="comments-section">
      <h3>è¯„è®º: </h3>
      <div id="comment-form">
        <textarea id="comment-content" required></textarea> </br>
        <button id="submitCommentBtn" class="inBodyButton" >å‘è¡¨è¯„è®º</button>
      </div>
      <div id="comments-list">
        <!-- è¯„è®ºå°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
      </div>
    

    </div>

    <script src="js/config.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/GoBoard11.js"></script>
    <script>
      const maxWinSize = 3000;
      const minWinSize = 300;
      const indicator = document.querySelector(".status-indicator");
      function calculateBoardSize() {
        const winWidth = window.innerWidth;
        const winHeight = window.innerHeight;
        //console.log("Post7.html, Line 83, winWidth is:", winWidth);
        //let cellSize = 20;

        // æ ¹æ®å®½åº¦è®¡ç®— cellSize
        if (winWidth < 480) {
          cellSizeFromWidth = Math.floor((winWidth - 20) / 20); // ä¸ºè¾¹æ¡†ç•™å‡ºä¸€äº›ç©ºé—´
          if (winWidth < minWinSize) {
            cellSizeFromWidth = Math.floor((minWinSize - 20) / 20);
          }
        } else if (winWidth > 768) {
          cellSizeFromWidth = Math.floor(winWidth / 28);
          if (winWidth > maxWinSize) {
            cellSizeFromWidth = Math.floor(maxWinSize / 28);
          }
        } else {
          cellSizeFromWidth = 30; // é»˜è®¤å°ºå¯¸
        }

        // æ ¹æ®é«˜åº¦è®¡ç®— cellSize
        if (winHeight < 480) {
          cellSizeFromHeight = Math.floor((winHeight - 20) / 20);
          if (winHeight < minWinSize) {
            cellSizeFromHeight = Math.floor((minWinSize - 20) / 20);
          }
        } else if (winHeight > 768) {
          cellSizeFromHeight = Math.floor(winHeight / 25);
          if (winHeight > maxWinSize) {
            cellSizeFromHeight = Math.floor(maxWinSize / 25);
          }
        } else {
          cellSizeFromHeight = 30; // é»˜è®¤å°ºå¯¸
        }

        // å–å®½åº¦å’Œé«˜åº¦è®¡ç®—ç»“æœä¸­çš„è¾ƒå°å€¼
        let cellSize = Math.min(cellSizeFromWidth, cellSizeFromHeight);

        const boardSize = 19;
        const stoneSize = Math.floor(cellSize * 0.95);

        let maxFrameWidth = cellSize * (boardSize + 3); // è®¡ç®—æ£‹ç›˜å®é™…å®½åº¦ //è¿™ä¸ªCSSè§£å†³äº†ï¼Œæš‚æ—¶ä¸ç”¨äº†ï¼Œå…ˆç•™ç€ã€‚8/5
        //console.log(
        //  "in calculateBoardSize(), maxFrameWidth is:",
        //  maxFrameWidth
        //);
        //console.log(
        //  "cellSize is:",
        //  cellSize,
        //  "boardSize is:",
        //  boardSize,
        //  "stoneSize is:",
        //  stoneSize
        //);

        return { cellSize, stoneSize, maxFrameWidth };
      }

      function updateStoneSizeCSS() {
        //const { stoneSize } = calculateBoardSize();
        //let { CSSstoneSize } = calculateBoardSize();
        let CSSstoneSize = cellSize * 0.8;
        // const stoneSizeWithUnit = `${stoneSize}px`;
        //const ttt = stoneDimension / 2;
        //console.log("updateStoneSizeCSS/stoneSize is:", stoneSizeWithUnit);
        //console.log("è®¡ç®—å¥½çš„ fontSize æ˜¯ï¼š", `${stoneSize}px`);
        document.documentElement.style.setProperty(
          "--stone-size",
          `${CSSstoneSize / 3}px`
        );
        document.documentElement.style.setProperty(
          "--cell-size",
          `${cellSize}px`
        );
        //console.log("--stone-sizeåº”è¯¥æ˜¯ï¼š", CSSstoneSize / 3);
        //console.log("Textarea widthåº”è¯¥æ˜¯ï¼š", cellSize * 20);

        document.documentElement.style.setProperty(
          "--font-size",
          `${CSSstoneSize / 2.4}px`
        );
        //console.log("--font-size åº”è¯¥æ˜¯", CSSstoneSize / 2);

        //console.log("stoneCSS is updated.");
      }

      function udpateSmbdStoneSizeCSS() {
        let CSSSmbdStoneSize = cellSize / 1.7;
        document.documentElement.style.setProperty(
          "--small-stone-size",
          `${CSSSmbdStoneSize / 3}px`
        );
        //console.log("--small-stone-size", CSSSmbdStoneSize / 3);

        document.documentElement.style.setProperty(
          "--small-font-size",
          `${CSSSmbdStoneSize / 4}px`
        );
        //console.log("--small-font-size åº”è¯¥æ˜¯ï¼š", CSSSmbdStoneSize / 4);
      }

      // window.globalBoardSize = calculateBoardSize(); //å¥½åƒæ˜¯æ²¡ç”¨äº†ï¼Œæ³¨é‡Šæ‰2024/7/27
      let { cellSize, stoneSize } = calculateBoardSize();
      updateStoneSizeCSS();
      udpateSmbdStoneSizeCSS();
      //console.log("stoneCSS should be updated.");
    </script>
    
    <!--<script src="js/Page.js"></script> -->
    <script type="module">
      import { initUserInfo } from './js/Page3.js';
      initUserInfo("post-user-info"); // æˆ–å…¶ä»– ID
    </script>
    <script>
      let currentGame = null; //æ”¾åˆ°OCIæ—¶å€™è¯´å·²ç»Declare, OCIä¸Šè¦commentæ‰ã€‚Localè¯•äº†ä¹Ÿæ²¡error 2024/7/15
      //createBoard();
      let currentMoves = [];
      let currentMoveIndex = -1;
      let showingRecentMoves = false;
      let displayMode = 0; //
      let postId; //å£°æ˜postIdä½œä¸ºå…¨å±€å˜é‡, 2024/7/16
      let globalPostId;  //å·²ç»å£°æ˜postIdå…¨å±€å˜é‡äº†ï¼Œè¦è€ƒå¯Ÿä¸ºä»€ä¹ˆåæ¥è¿˜éœ€è¦gloablePostId, 8/13
      var globalParsedMoves;

      loadNavbar();

      // åˆ›å»ºä¸»æ£‹ç›˜
      const mainBoard = document.getElementById("board");
      //console.log("mainBoard is:", mainBoard);
      //calculateBoardSize();
      //const { cellSize, boardSize, stoneSize } = calculateBoardSize();
      //console.log("Poståˆšæ‰“å¼€, stoneSize is:", stoneSize);
      //console.log("Attempting to create board");
      //const cellSizeValue = 28;
      //createBoard3({
      //  //line347 è¿˜æœ‰ä¸€ä¸ªï¼Œé‚£ä¸ªå¯è‡ªé€‚åº”ï¼Œè¿™ä¸ªä¸è¦äº†
      //  domElement: mainBoard,
      //  boardSize: 19,
      //  cellSize: cellSize,
      //  cellSize: 50,
      //});
      //console.log("Board creation completed, for cellSize is:", cellSize);
      //logMoveNumberFontSize();

      document
        .getElementById("forwardBtn")
        .addEventListener("click", moveForward);
      document
        .getElementById("backwardBtn")
        .addEventListener("click", moveBackward);
      document
        .getElementById("fastForwardBtn")
        .addEventListener("click", fastForward);
      document
        .getElementById("fastBackwardBtn")
        .addEventListener("click", fastBackward);
      document
        .getElementById("startBtn")
        .addEventListener("click", moveToStart);
      document.getElementById("endBtn").addEventListener("click", moveToEnd);
      document
        .getElementById("showMovesBtn")
        .addEventListener("click", toggleMoveDisplay);
      document
        .getElementById("saveQipuBtn")
        .addEventListener("click", saveQipu);

      //ç»™æ–°çš„Logo ç³»åˆ—æŒ‰é’®å¢åŠ ç›‘å¬

      document
        .getElementById("logoforwardBtn")
        .addEventListener("click", moveForward);
      document
        .getElementById("logobackwardBtn")
        .addEventListener("click", moveBackward);
      document
        .getElementById("logofastForwardBtn")
        .addEventListener("click", fastForward);
      document
        .getElementById("logofastBackwardBtn")
        .addEventListener("click", fastBackward);
      document
        .getElementById("logostartBtn")
        .addEventListener("click", moveToStart);
      document
        .getElementById("logoendBtn")
        .addEventListener("click", moveToEnd);
      document
        .getElementById("logoshowMovesBtn")
        .addEventListener("click", toggleMoveDisplay);
      document
        .getElementById("logosaveQipuBtn")
        .addEventListener("click", saveQipu);

      document
        .getElementById("submitCommentBtn")
        .addEventListener("click", publishVariation);

      //ä¿®æ”¹fechComment, è¯„è®ºå˜åŒ–å›¾ä¸€èµ· 2024/7/20
      function fetchComments(postId) {
        //fetch(`/api/comments/${postId}`)
        console.log("fetchComments called with postId:", postId);
        fetch(`${CONFIG.API_BASE_URL}/comments/${postId}`)
          .then((response) => response.json())
          .then((comments) => {
            const commentsList = document.getElementById("comments-list");
            commentsList.innerHTML = "";
            comments.forEach((comment) => {
              if (comment.variation) {
                //displayVariationComment(comment.content, comment.variation);
                displayVariationComment(comment, {
                  originalMoves: originalMoves,
                  variationMoves: variationMoves,
                });
              } else {
                const commentElement = document.createElement("div");
                commentElement.textContent = comment.content;
                commentsList.appendChild(commentElement);
              }
            });
          })
          .catch((error) => console.error("Error fetching comments:", error));
      }

      function loadPost(postId) {
        //console.log("loadPost, ç°åœ¨load:", postId);
        fetch(`${CONFIG.API_BASE_URL}/forum/post/${postId}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("HTTP error! status: ${response.status}");
            }
            return response.json();
          })
          .then((post) => {
            //console.log("Received post data:", post);
            // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
            const postContentElement = document.getElementById("post-content");

            if (postContentElement) {
              // æ¸…ç©ºç°æœ‰å†…å®¹
              postContentElement.innerHTML = "";

              // åˆ›å»ºæ ‡é¢˜å…ƒç´ 
              const titleElement = document.createElement("h3");
              titleElement.id = "post-title";
              titleElement.textContent = post.title;
              postContentElement.appendChild(titleElement);

              // åˆ›å»ºå†…å®¹æ®µè½
              const contentParagraph = document.createElement("p");
              contentParagraph.textContent = post.content;
              postContentElement.appendChild(contentParagraph);

              //console.log("Post title and content set successfully");
            } else {
              console.error("Element with id 'post-content' not found");
            }

            //if (post.sgfContent) {
            if (globalParsedMoves) {
              //console.log("è°ƒç”¨parseSGF2åœ¨ line 426 è¢«åœæ‰äº†ã€‚");
              //const parsedMoves = parseSGF2(post.sgfContent);
              //globalParsedMoves = parseSGF2(post.sgfContent);
              // Populate game info  //ä½†æ˜¯ä¸‹é¢è¿™å¥é‡Œçš„ parseSGF åŠ ä¸ä¸Šå»
              //console.log("é»‘æ£‹é€‰æ‰‹åº”è¯¥æ˜¯ï¼š", globalParsedMoves.gameInfo.blackPlayer);
              document.getElementById('black-player').textContent = globalParsedMoves.gameInfo.blackPlayer; 
              document.getElementById('white-player').textContent = globalParsedMoves.gameInfo.whitePlayer; 
              document.getElementById('black-rank').textContent = globalParsedMoves.gameInfo.blackRank; 
              console.log("ç•Œé¢åº”è¯¥å¾—åˆ°é»‘æ£‹æ®µä½ï¼š", globalParsedMoves.gameInfo.blackRank);
              document.getElementById('white-rank').textContent = globalParsedMoves.gameInfo.whiteRank; 
              document.getElementById('game-date').textContent = globalParsedMoves.gameInfo.date; 
              document.getElementById('game-komi').textContent = globalParsedMoves.gameInfo.komi; 
              document.getElementById('time-control').textContent = globalParsedMoves.gameInfo.timeControl; 
              document.getElementById('game-rules').textContent = globalParsedMoves.gameInfo.rules; 
              document.getElementById('game-result').textContent = globalParsedMoves.gameInfo.result; 
              document.getElementById('board-size').textContent = globalParsedMoves.gameInfo.boardSize; 

              //JustMoves = parsedMoves.moves;
              JustMoves = globalParsedMoves.moves;
              //console.log("JustMoves:", JustMoves);
              renderMoves(JustMoves);
            }
          })
          .catch((error) => {
            console.error("Error fetching post:", error);
          });
        //cellSize = cellSize;
        loadComments(postId);
      }

      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOMContentLoaded event fired");
        console.log("Full URL:", window.location.href);
        console.log("Search part of URL:", window.location.search);
        
        const urlParams = new URLSearchParams(window.location.search);

        console.log("URL search params:", urlParams.toString());
        //let queryString = window.location.search;
        //console.log("queryString:", queryString);
        postId = urlParams.get("id");
        globalPostId = postId;
        console.log("urlParams:", urlParams);
        //console.log("Post ID from URL:", postId);
        //publishVariation();

        if (globalPostId) {
          console.log("postId is not globalPostId:", globalPostId);
          //fetch(`/api/post/${postId}`)
          fetch(`${CONFIG.API_BASE_URL}/forum/post/${globalPostId}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((post) => {
              console.log("right before loadPost, globalPostId is:", globalPostId);
              loadPost(globalPostId);
              //ä¸‹é¢å‡ è¡Œloadäº†postå†…å®¹ã€‚æ”¹ç”¨lostPostå‡½æ•° 2024/7/25
              //document.getElementById("post-title").textContent = post.title;
              //document.getElementById(
              //  "post-content"
              //).innerHTML += `<p>${post.content}</p>`;
              //console.log("post.sgfContent is:", post.sgfContent);

              if (post.sgfContent) {
                //console.log("è°ƒç”¨parseSGFåœ¨ line 523");
                //const parsedMoves = parseSGF2(post.sgfContent);
                globalParsedMoves= parseSGF(post.sgfContent);
                console.log("globalParsedMoves is:", globalParsedMoves);
                //createBoard();
                //ä¸‹é¢è¿™ä¸ªcreateBoard3é‡å¤äº†ï¼Œä½†ä¿ç•™è¿™ä¸ª;
                createBoard3({
                  domElement: mainBoard,
                  boardSize: 19,
                  cellSize: cellSize,
                });
                console.log("åˆ›å»ºäº†Posté‡Œçš„æ£‹ç›˜ï¼ŒcellSize is:", cellSize);
                renderMoves(globalParsedMoves);

                // æ·»åŠ æ§åˆ¶æŒ‰é’®çš„åŠŸèƒ½
                document
                  .getElementById("startBtn")
                  .addEventListener("click", moveToStart);
                document
                  .getElementById("endBtn")
                  .addEventListener("click", moveToEnd);
                document
                  .getElementById("backwardBtn")
                  .addEventListener("click", moveBackward);
                document
                  .getElementById("forwardBtn")
                  .addEventListener("click", moveForward);
                document
                  .getElementById("fastBackwardBtn")
                  .addEventListener("click", fastBackward);
                document
                  .getElementById("fastForwardBtn")
                  .addEventListener("click", fastForward);
                //å¥½åƒè¿™ä¸ªlistenerè¿˜ä¸èƒ½è¿™ä¹ˆæ—©åŠ è½½ï¼Œå› ä¸ºno postId provided..
                //     document
                //     .getElementById("publishVariationBtn")
                //     .addEventListener("click", publishVariation);
              }
            })
            .catch((error) => {
              console.error("Error fetching post:", error);
            });
        } else {
          console.error("No post ID provided in the UR, ä¸ä¸€å®šæ˜¯è¿™ä¸ªåŸå› ï¼Œå°±æ˜¯æœ‰error");
        }
        //setTimeout(logMoveNumberFontSize, 100);
      });  //è¿™ä¸ªæ˜¯å‘å¸ƒå˜åŒ–å›¾submit çš„å‡½æ•°ï¼Œæ²¡æœ‰æ­£ç¡®å·¥ä½œã€‚å¦‚æœæŠŠæ•´ä¸ªå‡½æ•°å…¨commentæ‰ï¼Œåˆ™åˆšæ‰“å¼€postçš„æ—¶å€™æ£‹ç›˜æ˜¾ç¤ºä¸å‡ºæ¥ã€‚ï¼Ÿ8/12/2024

      async function loadComments(globalPostId) {
        console.log("è°ƒç”¨loadCommentså‡½æ•°ï¼ŒpostId:", postId);
        try {
          console.log(`Fetching comments for post: ${postId}`);
          //const response = await fetch(`/forum/comments/${postId}`);
          const response = await fetch(`${CONFIG.API_BASE_URL}/comments/${globalPostId}`);
          if (!response.ok) {
            console.error(`Error: ${response.status} - ${response.statusText}`);
            const text = await response.text();
            console.error(`Response body: ${text}`);
            return;
          }

          const comments = await response.json();

          const commentsList = document.getElementById("comments-list");
          commentsList.innerHTML = ""; // æ¸…ç©ºå·²æœ‰è¯„è®º

          if (Array.isArray(comments) && comments.length > 0) {
            comments.forEach((comment) => {
              console.log("Processing comment:", comment);
              //console.log("comment.originalMoves is:", comment.originalMoves);
              //console.log("comment.variationMoves is:", comment.variationMoves);
              displayVariationComment(
                comment.content,
                comment.originalMoves,
                comment.variationMoves
              );
            });
          } else {
            // å¦‚æœæ²¡æœ‰è¯„è®ºï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤ºä¿¡æ¯
            const noCommentsMessage = document.createElement("p");
            noCommentsMessage.textContent = "æš‚æ— è¯„è®º";
            noCommentsMessage.className = "no-comments-message";
            commentsList.appendChild(noCommentsMessage);
          }
        } catch (error) {
          console.error("Error loading comments:", error);
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
          const errorMessage = document.createElement("p");
          errorMessage.textContent = "åŠ è½½è¯„è®ºæ—¶å‡ºé”™ï¼Œè¯·ç¨åå†è¯•ã€‚";
          errorMessage.className = "error-message";
          document.getElementById("comments-list").appendChild(errorMessage);
        }
      }

      const studyButton = document.getElementById("studyButton");
      if (studyButton) {
        studyButton.addEventListener("click", toggleStudyMode);
      }

      const logostudyBtn = document.getElementById("logostudyBtn");
      if (logostudyBtn) {
        logostudyBtn.addEventListener("click", function () {
          toggleStudyMode2("studyIndicator");
        });
      }

      //ä¸‹é¢çš„AddEventListenerè½¬ç§»åˆ°ä¸Šé¢å’Œå…¶ä»–btnä¸€èµ·åŠ è½½listener, 2024/7/25
      document
        .getElementById("publishVariationBtn")
        .addEventListener("click", publishVariation);
      //document
      //  .getElementById("publishCommentBtn")
      //  .addEventListener("click", publishComment);

      function initializeSmallBoard(boardElement, moves) {
        const originalBoard = document.getElementById("board");
        const originalStyle = window.getComputedStyle(originalBoard);
        const scaleFactor = 0.5; // å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¿™ä¸ªç¼©æ”¾å› å­
        console.log("ç°åœ¨ç”»ä¸€ä¸ªå°æ£‹ç›˜ã€‚");

        // è®¾ç½®å°æ£‹ç›˜çš„å¤§å°
        boardElement.style.width = `${
          parseFloat(originalStyle.width) * scaleFactor
        }px`;
        boardElement.style.height = `${
          parseFloat(originalStyle.height) * scaleFactor
        }px`;
        boardElement.style.position = "relative";
        boardElement.style.overflow = "hidden";

        // åˆ›å»ºä¸€ä¸ªç¼©æ”¾å®¹å™¨
        const scaleContainer = document.createElement("div");
        scaleContainer.style.transform = `scale(${scaleFactor})`;
        scaleContainer.style.transformOrigin = "top left";
        scaleContainer.style.width = `${100 / scaleFactor}%`;
        scaleContainer.style.height = `${100 / scaleFactor}%`;
        boardElement.appendChild(scaleContainer);

        // ä½¿ç”¨ç°æœ‰çš„ createBoard å‡½æ•°
        createBoard.call({ board: scaleContainer });

        let smallBoardMoveIndex = 0;

        function renderSmallBoard() {
          // æ¸…é™¤æ‰€æœ‰æ£‹å­
          scaleContainer
            .querySelectorAll(".stone")
            .forEach((stone) => stone.remove());

          // é‡æ–°æ¸²æŸ“æ£‹ç›˜çŠ¶æ€
          for (let i = 0; i <= smallBoardMoveIndex; i++) {
            const move = moves[i];
            if (!move.pass) {
              const intersection = scaleContainer.querySelector(
                `[data-row="${move.row}"][data-col="${move.col}"]`
              );
              const stone = document.createElement("div");
              stone.className = `stone ${move.color}`;
              stone.textContent = i + 1; // æ˜¾ç¤ºæ­¥æ•°
              intersection.appendChild(stone);
            }
          }
        }

        // æ·»åŠ æ§åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        const prevButton =
          boardElement.parentNode.querySelector(".small-board-prev");
        const nextButton =
          boardElement.parentNode.querySelector(".small-board-next");

        prevButton.addEventListener("click", () => {
          if (smallBoardMoveIndex > 0) {
            smallBoardMoveIndex--;
            renderSmallBoard();
          }
        });

        nextButton.addEventListener("click", () => {
          if (smallBoardMoveIndex < moves.length - 1) {
            smallBoardMoveIndex++;
            renderSmallBoard();
          }
        });

        renderSmallBoard(); // åˆå§‹æ¸²æŸ“

        // å‡†å¤‡è¦å‘é€åˆ°åç«¯çš„æ•°æ®
        const commentData = {
          postId: currentPostId, // ç¡®ä¿ä½ æœ‰å½“å‰å¸–å­çš„ID
          content: comment,
          originalMoves: originalMoves.map((move) => `${move.x},${move.y}`),
          variationMoves: variationMoves.map((move) => `${move.x},${move.y}`),
        };

        // å‘é€è¯„è®ºæ•°æ®åˆ°åç«¯
        fetch(`${CONFIG.API_BASE_URL}/comments/${postId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(commentData),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Comment saved successfully:", data);
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–çš„é€»è¾‘ï¼Œæ¯”å¦‚ï¿½ï¿½æ–°UIç­‰
          })
          .catch((error) => {
            console.error("Error saving comment:", error);
            alert("ä¿å­˜è¯„è®ºæ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•");
          });
      }

      //æ£€æŸ¥localStorageè¿˜æœ‰ç”¨æˆ·ä¿¡æ¯
      console.log("User in localStorage:", localStorage.getItem("user"));

      function playStoneSound() {
        const audio = document.getElementById("stoneSound");
        audio.volume = 0.2; // è®¾ç½®éŸ³é‡ä¸º50%
        audio.currentTime = 0; // é‡ç½®éŸ³é¢‘åˆ°å¼€å§‹
        audio.play();
      }

      //const indicator = document.querySelector('.status-indicator');  //constæ”¾åœ¨å¼€å§‹äº†

      function toggleIndicator2() {
        indicator.classList.toggle("active");
        console.log(
          `Indicator is now ${
            indicator.classList.contains("active") ? "active" : "inactive"
          }`
        );
        console.log("Current classes:", indicator.className);
      }
    </script>

    <!--  å¢åŠ è½å­éŸ³æ•ˆ -->
    <audio id="stoneSound" src="Sounds/PlayStone2.mp3" preload="auto"></audio>
  </body>
</html>
